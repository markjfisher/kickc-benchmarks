#pragma data_seg(DList)

#include "gr.h"
#include "atari-system.h"

__export char dl8[] = {
	0xf0, 0x70, 0x70,
	0x42, counterLms, 0x00,
	0xf0,
	0x4f, LOBYTE(lms), HIBYTE(lms),
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 
	0x4f, 0, HIBYTE(lms) + 0x10,
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
	0x41, LOBYTE(dl8), HIBYTE(dl8)
	};

__export char dl4[] = {
	0x70, 0x70, 0x70,
	0x42, counterLms, 0x00,
	0x70,
	0x49, LOBYTE(lms), HIBYTE(lms),
	0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 
	0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 
	0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 
	0x09, 0x09, 0x09, 0x09, 
	0x41, LOBYTE(dl4), HIBYTE(dl4)
	};

__export char dlCounter[] = {
	0x70, 0x70, 0x70,
	0x42, counterLms, 0x00,
	0x41, LOBYTE(dlCounter), HIBYTE(dlCounter)
	};

__export char dlScore[] = {
	0x70, 0x70, 0x70,
	0x42, LOBYTE(scoreLms), HIBYTE(scoreLms),
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
	0x02, 0x02, 0x02, 
	0x41, LOBYTE(dlScore), HIBYTE(dlScore),
	};

__export char dlFire[] = {
	0xf0, 0x70, 0x70,
	0x42, counterLms, 0x00,
	0xf0,
	0x42, LOBYTE(lms) - 0x10, HIBYTE(lms) + 4,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
	0x41, LOBYTE(dlFire), HIBYTE(dlFire)
	};

#pragma code_seg(Code)

void mode8() {
	*DLIST = dl8;	
}

void mode4() {
	*DLIST = dl4;
}

void modeFire() {
	*DLIST = dlFire;
}

void counterRow() {
	*DLIST = dlCounter;
}

void showScore() {
	waitFrame();
	// change back to main charset, should be 0x8000, so high byte = 0x80
	*CHBASE = HIBYTE(charset);
	*DLIST = dlScore;
}

char * strToCode(char *s) {
	char *p = s;
	while(*p != 0) {
		char c = convertAtasciiToCode(*p);
		// in our charset, the space is now at position 0xfe, so fix it.
		if (c == 0) c = 0xfe;
		*p = c;
		p++;
	}
	return s;
}

char convertCodeToAtascii(char c) {
	char inverseBit = c & 0x80;
	char noInverse  = c & 0x7f;
	if      (noInverse < 0x40) noInverse += 0x20;
	else if (noInverse < 0x60) noInverse -= 0x40;
	return noInverse | inverseBit;
}

char convertAtasciiToCode(char c) {
	char inverseBit = c & 0x80;
	char noInverse  = c & 0x7f;
	if      (noInverse < 0x20) noInverse += 0x40;
	else if (noInverse < 0x60) noInverse -= 0x20;
	return noInverse | inverseBit;
}

void priorOff() {
	*PRIOR = 0;
	setDLI(&priorOn);
}

void priorOn() {
	*PRIOR = 0x40;
	setDLI(&priorOff);
}

void priorOffFire() {
	*PRIOR = 0;
	ANTIC->DMACTL = 0x22;

	// for the scoreboard
	*CHBASE = HIBYTE(charset + 0x400);
	setDLI(&priorOnFire);
}

void priorOnFire() {
	*PRIOR = 0x40;
	ANTIC->DMACTL = 0x21;

	// for the fire
	*CHBASE = HIBYTE(fireCharset);
	setDLI(&priorOffFire);
}
